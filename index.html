<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Lua在线运行工具</title>
    <meta name="description" content="在线运行Lua脚本">
    <meta name="author" content="chenxuuu">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="js/fengari-web.js" type="text/javascript"></script>
    <script src="js/codeflask.min.js" type="text/javascript"></script>
    <script src="js/prism.js" type="text/javascript"></script>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <h3>
                    Lua在线运行工具
                </h3>
                <div class="alert alert-warning alert-dismissable">
                    <h4>注意</h4>
                    每次运行时，Lua虚拟机并不会刷新，前一次的变量都会被保存。如果需要彻底重新运行，请保留代码后，刷新本页面。<br>
                    除了打开别人分享的代码，其他代码都会自动保存在浏览器缓存，下次打开自动加载。<br>
                    Lua运行环境为Lua 5.3
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <h3>
                    待运行代码：
                </h3>
                <div class="form-control">
                    <div id="code" style="position: relative;width: 100%;height: 300px;"></div>
                </div>
                <button class="btn btn-primary btn-block btn-outline-primary" onclick="getResult()">
                    运行
                </button>
            </div>
            <div class="col-md-6">
                <h3>
                    运行结果：
                </h3>
                <textarea class="form-control" id="output"
                    style="position: relative;width: 100%;height: 317px;">等待运行</textarea>
                <button class="btn btn-primary btn-block btn-outline-primary" id="d_clip_button" data-clipboard-text="">
                    分享这段代码
                </button>
            </div>
        </div>
    </div>
    <div style="text-align: center;"><a href="https://github.com/chenxuuu/lua-online" target="_blank">GitHub 源码</a>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script>
        var flask = new CodeFlask('#code', {
            language: 'lua',
            lineNumbers: true
        });
        flask.addLanguage("lua", Prism.languages.lua);

        var pageurl = window.location.href;
        if(pageurl.indexOf("?") >= 0)
            pageurl = pageurl.substring(0,pageurl.indexOf("?"));
        var shareButton = document.getElementById("d_clip_button");
        flask.onUpdate((code) => {
            if (location.search == "")
                localStorage.setItem("code", code);
            shareButton.setAttribute("data-clipboard-text",pageurl+"?"+encodeURI(code));
        });

        if (location.search != "")
            flask.updateCode(decodeURI(location.search.substring(1)) + "\r\n--此代码为分享代码，不会自动保存，关闭浏览器后即消失");
        else if (localStorage.getItem("code") != null) {
            flask.updateCode(localStorage.getItem("code"));
        }

        function luaPrint(s) {
            var textarea = $("#output").append(s + "\n");
            textarea.scrollTop(textarea[0].scrollHeight - textarea.height());
        }

        fengari.load(`
js = require "js"
--重写print函数
function print(...)
    local out = {}
    for i=1,select('#', ...) do
        table.insert(out,tostring(select(i, ...)))
    end
    js.global:luaPrint(table.concat(out,"\t"))
end
package.path = "./lua/?.lua"
require("head")`)();

        function getResult() {
            var code = flask.getCode();
            $("#output").text("");
            try {
                fengari.load(code)();
            }
            catch (err) {
                luaPrint(err);
            }
        }
    </script>
    <script type="text/javascript" src="js/clipboard.min.js"></script>
    <script>
        var btn = document.getElementById('d_clip_button');
        var clipboard = new ClipboardJS(btn);

        clipboard.on('success', function (e) {
            alert("复制成功~粘贴即可分享代码链接");
        });
        clipboard.on('error', function (e) {
            alert("复制失败了呢，你还是手动复制吧");
        });
    </script>
</body>

</html>
